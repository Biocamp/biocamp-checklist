{% extends "base.html" %}
{% block title %}Valida√ß√£o ‚Ä¢ {{ ship.title }}{% endblock %}

{% block content %}
<h1>Valida√ß√£o do Checklist: {{ ship.title }}</h1>

<p class="muted">
  {% if g.viewer_name %}
    Usu√°rio: <strong>{{ g.viewer_name }} &lt;{{ g.viewer_email }}&gt;</strong>
  {% else %}
    Acesso como <strong>Convidado</strong>.
  {% endif %}
</p>

{# Galeria de imagens do checklist (ship-level) #}
{% if gallery and gallery|length > 0 %}
  <div style="margin:12px 0; display:flex; gap:10px; flex-wrap:wrap">
    {% for gimg in gallery %}
      <a href="{{ url_for('uploaded_file', filename=gimg.filename) }}" target="_blank" rel="noopener" title="ver anexo">
        <img src="{{ url_for('uploaded_file', filename=gimg.filename) }}"
             alt="anexo" style="width:110px;height:85px;object-fit:cover;border:1px solid #e2e8f0;border-radius:6px;">
      </a>
    {% endfor %}
  </div>
{% endif %}

{% if not can_edit and ship.responsible_email %}
  <div class="muted" style="background:#f1f5f9;border:1px solid #e2e8f0;padding:10px 12px;border-radius:8px;margin-bottom:14px">
    Visualiza√ß√£o apenas. <strong>Somente o respons√°vel ({{ ship.responsible_email }})</strong> pode confirmar.
  </div>
{% endif %}

<form method="post" action="{{ url_for('open_public', token=ship.token) }}" onsubmit="lockSubmit(this)">
  <table>
    <thead>
      <tr>
        <th style="width:80px">Confirmar</th>
        <th>Item</th>
        <th style="width:40%">Status</th>
        <th style="width:160px">A√ß√µes</th>
      </tr>
    </thead>
    <tbody>
      {% for it in items %}
      <tr>
        <!-- Coluna: checkbox de sele√ß√£o -->
        <td>
          {% if can_edit and not it.confirmed_at %}
            <input type="checkbox" name="items" value="{{ it.id }}">
          {% else %}
            <input type="checkbox" disabled>
          {% endif %}
        </td>

        <!-- Coluna: item + imagens (suporta 1 ou v√°rias imagens) -->
        <td>
          <div>{{ it.label }}</div>

          {% if it.images %}
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px">
              {% for img in it.images %}
                {% set href = img.image_url
                              or (url_for('uploaded_file', filename=img.image_filename) if img.image_filename else None) %}
                {% if href %}
                  <a href="{{ href }}" target="_blank" rel="noopener" title="ver anexo">
                    <img src="{{ href }}" alt="anexo" style="width:90px; height:70px; object-fit:cover; border:1px solid #e2e8f0; border-radius:6px;">
                  </a>
                {% endif %}
              {% endfor %}
            </div>
          {% else %}
            {% if it.image_url %}
              <div style="margin-top:8px">
                <a href="{{ it.image_url }}" target="_blank" rel="noopener">
                  <img src="{{ it.image_url }}" alt="anexo" style="max-width:120px; max-height:90px; border:1px solid #e2e8f0; border-radius:6px;">
                </a>
              </div>
            {% elif it.image_filename %}
              <div style="margin-top:8px">
                <a href="{{ url_for('uploaded_file', filename=it.image_filename) }}" target="_blank" rel="noopener">
                  <img src="{{ url_for('uploaded_file', filename=it.image_filename) }}" alt="anexo" style="max-width:120px; max-height:90px; border:1px solid #e2e8f0; border-radius:6px;">
                </a>
              </div>
            {% elif it.external_url %}
              <div style="margin-top:8px">
                <a href="{{ it.external_url }}" target="_blank" rel="noopener">
                  <img src="{{ it.external_url }}" alt="anexo" style="max-width:120px; max-height:90px; border:1px solid #e2e8f0; border-radius:6px;">
                </a>
              </div>
            {% endif %}
          {% endif %}
        </td>

        <!-- Coluna: status -->
        <td class="muted">
          {% if it.viewed_at %}
            üëÅÔ∏è Visto por {{ it.viewed_by or '‚Äî' }} em {{ it.viewed_at|dt }}
          {% else %}
            üëÅÔ∏è Ainda n√£o visto
          {% endif %}
          <br>
          {% if it.confirmed_at %}
            ‚úîÔ∏è Confirmado por <strong>{{ it.confirmed_by }}</strong> em {{ it.confirmed_at|dt }}
          {% else %}
            üïì Aguardando confirma√ß√£o
          {% endif %}
        </td>

        <!-- Coluna: a√ß√µes (bloqueia quando confirmado) -->
        <td>
          {% if it.confirmed_at %}
            <span class="muted">‚Äî</span>
          {% else %}
            <button class="btn success" type="submit" name="items" value="{{ it.id }}" {% if not can_edit %}disabled{% endif %}>
              Confirmar
            </button>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div style="display:flex;gap:12px;margin-top:16px">
    <button class="btn success" type="submit" name="bulk" value="selected" {% if not can_edit %}disabled{% endif %}>
      Confirmar selecionados
    </button>
    <button class="btn" type="submit" name="confirm_all" value="1" {% if not can_edit %}disabled{% endif %}>
      Confirmar todos
    </button>
  </div>
</form>

<script>
function lockSubmit(form) {
  const btns = form.querySelectorAll('button[type="submit"]');
  btns.forEach(b => { b.disabled = true; b.classList.add('is-loading'); });
}
</script>
{% endblock %}
